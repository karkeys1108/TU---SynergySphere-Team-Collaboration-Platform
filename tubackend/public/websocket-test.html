<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - Project Chat</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        #chat-container { display: none; margin-top: 20px; }
        #messages {
            height: 300px;
            border: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .message { margin: 10px 0; padding: 8px 12px; border-radius: 4px; }
        .message.self { background-color: #e3f2fd; margin-left: 20%; }
        .message.other { background-color: #f1f1f1; margin-right: 20%; }
        .message .sender { font-weight: bold; color: #333; }
        .message .time { font-size: 0.8em; color: #666; margin-left: 10px; }
        #message-form { display: flex; margin-top: 15px; }
        #message-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 16px; margin-left: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background-color: #cccccc; }
        #user-info { margin: 15px 0; }
    </style>
</head>
<body>
    <h1>Project Chat</h1>
    
    <div id="status" class="disconnected">Disconnected</div>
    
    <div id="user-info">
        <div>
            <label for="username">Your Name:</label>
            <input type="text" id="username" placeholder="Enter your name" value="User">
        </div>
        <div style="margin-top: 10px;">
            <label for="projectId">Project ID:</label>
            <input type="text" id="projectId" value="68bbb77d88e10d2d822fe708" style="width: 300px;">
            <button onclick="joinProject()">Join Project</button>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="messages"></div>
        <form id="message-form" onsubmit="sendMessage(); return false;">
            <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>

    <script>
        const socket = io('http://localhost:5000');
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatContainer = document.getElementById('chat-container');
        let currentProjectId = '';
        let username = 'User';

        // Connection handling
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
            statusEl.textContent = 'Connected';
            statusEl.className = 'connected';
            addSystemMessage('Connected to the chat server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket server');
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'disconnected';
            addSystemMessage('Disconnected from the chat server');
        });

        // Handle incoming messages
        socket.on('newMessage', (data) => {
            console.log('New message:', data);
            addMessage(data.user || 'Anonymous', data.message, data.timestamp, false);
        });

        socket.on('userJoined', (data) => {
            console.log('User joined:', data);
            addSystemMessage(data.message || 'A user joined the project');
        });

        // Join project room
        function joinProject() {
            currentProjectId = document.getElementById('projectId').value.trim();
            username = document.getElementById('username').value.trim() || 'User';
            
            if (currentProjectId) {
                socket.emit('joinProject', currentProjectId);
                chatContainer.style.display = 'block';
                addSystemMessage(`Joined project: ${currentProjectId}`);
                messageInput.focus();
            }
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentProjectId) return;

            // Emit the message to the server
            socket.emit('sendMessage', {
                projectId: currentProjectId,
                message: message,
                user: username
            });

            // Add the message to the UI immediately
            addMessage(username, message, new Date().toISOString(), true);
            
            // Clear the input
            messageInput.value = '';
        }

        // Helper functions
        function addMessage(sender, text, timestamp, isSelf) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSelf ? 'self' : 'other'}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="sender">${sender} <span class="time">${time}</span></div>
                <div>${text}</div>
            `;
            
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.color = '#666';
            messageDiv.textContent = text;
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Handle Enter key to send message
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-focus message input when joining
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinProject();
            }
        });
    </script>
</body>
</html>
